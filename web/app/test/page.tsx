"use client";

import { ConnectButton } from '@rainbow-me/rainbowkit'
import { createWalletClient, custom, http, parseUnits, type Address, encodeFunctionData, erc20Abi } from "viem";
import { erc7715ProviderActions } from "@metamask/smart-accounts-kit/actions";
import { erc7710WalletActions } from "@metamask/smart-accounts-kit/actions";
import { sepolia as chain } from "viem/chains";

const page = () => {
    
const sessionAccount = "0x0b0074abab42fc65f941c9a219ad3f44693f2c1c"
// USDC address on Ethereum Sepolia.
const tokenAddress: Address = "0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238";
const delegationManager: Address = "0xdb9B1e94B5b69Df7e401DDbedE43491141047dB3";
const context = "0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000b0074abab42fc65f941c9a219ad3f44693f2c1c0000000000000000000000007b4d0d165b84ff62f39e42a0b9b3b521d8e25759ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000c0ad159363ab5742539d7a7d19ac9dc2119ef0554995317f637adeed950ea218af00000000000000000000000000000000000000000000000000000000000004c00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000320000000000000000000000000474e3ae7e169e940607cc624da8a15eb120139ab0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000741c7d4b196cb0c7b01d743fbc6116a902379c723800000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000001518000000000000000000000000000000000000000000000000000000000694eaa3e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000092bf12322527caa612fd31a0e810472bbb106a8f000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001046bb45c8d673d4ea75321280db34899413c069000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000006957e4bc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000de4f2fac4b3d87a1d9953ca5fc09fca7f366254f000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000418a76f96c6f4b7142d5d217dacc70f25b91254cdb1bd9360d3552bbf2e06ade23402ba4d43ad71bc9513227b77947da91c0c1e9c0598516f742f0efc5dd9d1e8d1b00000000000000000000000000000000000000000000000000000000000000";
const delegator ="0xdb9B1e94B5b69Df7e401DDbedE43491141047dB3"
const requestPermissions = async () => {
const walletClient = createWalletClient({
        transport: custom(window.ethereum),
      }).extend(erc7715ProviderActions());
const currentTime = Math.floor(Date.now() / 1000);
// 1 week from now.
const expiry = currentTime + 604800;

 const grantedPermissions = await walletClient.requestExecutionPermissions([{
  chainId: chain.id,
  expiry,
  signer: {
    type: "account",
    data: {
      // The requested permissions will granted to the
      // session account.
      address: sessionAccount,
    },
  },
  permission: {
    type: "erc20-token-periodic",
    data: {
      tokenAddress,
      // 1 USDC in WEI format. Since USDC has 6 decimals, 10 * 10^6
      periodAmount: parseUnits("10", 6),
      // 1 day in seconds
      periodDuration: 86400,
      justification: "Permission to transfer 1 USDC every day",
    },
  },
  isAdjustmentAllowed: true,
}]);
console.log(grantedPermissions);
}


const redeemPermissions = async () => {

 const sessionAccountWalletClient = createWalletClient({
        account: delegator,
        chain,
        transport: custom(window.ethereum),
      }).extend(erc7710WalletActions());

 const calldata = encodeFunctionData({
        abi: erc20Abi,
        args: [ "0x4d3b8dd169fa999a3689ef6eeea640d0468de0fe", parseUnits("1", 5) ],
        functionName: 'transfer',
      });
      const transactionHash = await sessionAccountWalletClient.sendTransactionWithDelegation({
        account: sessionAccount as Address,
        chain,
        to: tokenAddress,
        data: calldata,
        gas: 500000n,
        permissionsContext: context as `0x${string}`,
        delegationManager: delegationManager,
      });
      console.log(transactionHash);
  }
  return (
    <div>
        <h1>Test Page</h1>
        <ConnectButton />
        <button onClick={requestPermissions}>Request Permissions</button>
        <button onClick={redeemPermissions}>Redeem Permissions</button>
    </div>
  )
}

export default page
